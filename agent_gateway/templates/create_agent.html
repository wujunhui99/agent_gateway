<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Create Agent</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 24px; background: #f6f8fa; }
        h1 { margin-bottom: 16px; }
        form { background: #ffffff; border-radius: 8px; padding: 24px; max-width: 640px; box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1); }
        label { display: block; margin-top: 12px; font-weight: 600; }
        input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea {
            width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #d1d9e0; border-radius: 6px; font-size: 14px;
        }
        textarea { min-height: 72px; resize: vertical; }
        .actions { margin-top: 24px; display: flex; gap: 12px; align-items: center; }
        button { padding: 10px 18px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        .status { margin-top: 20px; }
        .status pre { background: #0f172a; color: #e2e8f0; padding: 16px; border-radius: 6px; overflow-x: auto; }
        .hint { font-size: 12px; color: #64748b; margin-top: 4px; }
        .row { display: flex; gap: 16px; }
        .row .col { flex: 1; }
        .checkbox { display: flex; align-items: center; gap: 8px; margin-top: 16px; }
    </style>
</head>
<body>
    <h1>Create Agent</h1>
    <form id="agent-form">
        <label>
            Bot User ID
            <input type="text" name="bot_user_id" value="bot_agent_qwen" required />
            <div class="hint">Must match the configured prefix.</div>
        </label>
        <label>
            Name
            <input type="text" name="name" value="QwenAgent" required />
            <div class="hint">Internal name used when referencing the agent in prompts.</div>
        </label>
        <label>
            Nickname
            <input type="text" name="nickname" value="Qwen Agent" required />
        </label>
        <div class="row">
            <div class="col">
                <label>
                    API Base
                    <input type="url" name="api_base" value="https://dashscope.aliyuncs.com/compatible-mode/v1" required />
                </label>
            </div>
            <div class="col">
                <label>
                    Model
                    <input type="text" name="model" value="qwen-plus" required />
                </label>
            </div>
        </div>
        <label>
            API Key
            <input type="text" name="api_key" placeholder="sk-..." required />
        </label>
        <label>
            System Prompt
            <textarea name="system_prompt">You are Qwen, a helpful assistant.</textarea>
        </label>
        <div class="row">
            <div class="col">
                <label>
                    Memory Size
                    <input type="number" name="memory_size" value="10" min="0" />
                </label>
            </div>
            <div class="col">
                <label>
                    Redis URL (optional)
                    <input type="text" name="redis_url" placeholder="redis://localhost:6379/0" />
                </label>
            </div>
        </div>
        <label>
            Face URL (optional)
            <input type="url" name="face_url" placeholder="https://example.com/avatar.png" />
        </label>
        <div>
            <span class="hint">Select the tools this agent can access:</span>
            <div class="tool-grid">
                {{TOOLS}}
            </div>
        </div>
        <label>
            Friends (user IDs, comma or newline separated)
            <textarea name="friends" placeholder="alice,bob"></textarea>
        </label>
        <label class="checkbox">
            <input type="checkbox" name="enabled" checked />
            Enable agent immediately
        </label>
        <div class="actions">
            <button type="submit">Create Agent</button>
            <span id="form-status" class="hint"></span>
        </div>
        <div class="status" id="result"></div>
    </form>
    <script>
        const form = document.getElementById("agent-form");
        const status = document.getElementById("form-status");
        const result = document.getElementById("result");

        function parseFriends(value) {
            return value
                .split(/[\n,]/)
                .map((item) => item.trim())
                .filter((item, index, arr) => item.length > 0 && arr.indexOf(item) === index);
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            status.textContent = "Submitting...";
            result.innerHTML = "";

            const formData = new FormData(form);
            const payload = {
                bot_user_id: formData.get("bot_user_id").trim(),
                name: formData.get("name").trim(),
                nickname: formData.get("nickname").trim(),
                api_base: formData.get("api_base").trim(),
                model: formData.get("model").trim(),
                api_key: formData.get("api_key").trim(),
                system_prompt: formData.get("system_prompt").trim(),
                memory_size: Number(formData.get("memory_size") || 0),
                enabled: formData.get("enabled") === "on",
                friends: parseFriends(formData.get("friends") || ""),
            };

            const allowedTools = Array.from(
                form.querySelectorAll('input[name="allowed_tools"]:checked')
            ).map((input) => input.value);
            if (allowedTools.length > 0) {
                payload.allowed_tools = allowedTools;
            } else {
                delete payload.allowed_tools;
            }

            const redisUrl = formData.get("redis_url").trim();
            if (redisUrl) {
                payload.redis_url = redisUrl;
            }
            const faceUrl = formData.get("face_url").trim();
            if (faceUrl) {
                payload.face_url = faceUrl;
            }

            try {
                const response = await fetch("/agents", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || JSON.stringify(data));
                }

                status.textContent = "Agent created successfully.";
                result.innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
            } catch (err) {
                status.textContent = "Failed to create agent.";
                result.innerHTML = "<pre>" + err.message + "</pre>";
            }
        });
    </script>
</body>
</html>
